name: åŒæ­¥èµ„äº§æ—¥å¿—åˆ°ä¸»é¡µå¹¶ä¿å­˜READMEå‰¯æœ¬
on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 1 * * *" # UTC+8å‡Œæ™¨1ç‚¹
  workflow_dispatch:
    inputs:
      force_update:
        description: 'æ˜¯å¦å¼ºåˆ¶æ›´æ–°'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  sync-readme:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # æµ…å…‹éš†åŠ é€Ÿ

      - name: è·å–ç›®æ ‡ä»“åº“READMEå†…å®¹
        id: fetch-readme
        run: |
          set -euo pipefail
          TARGET_REPO="harry0703/MoneyPrinterTurbo"
          README_URL="https://raw.githubusercontent.com/${TARGET_REPO}/main/README.md"
          curl -s "$README_URL" > temp_readme.md
          echo "å·²å°†ç›®æ ‡ä»“åº“READMEä¿å­˜ä¸ºtemp_readme.mdåˆ°ä»“åº“æ ¹ç›®å½•"

      - name: æå–èµ„äº§æ—¥å¿—å¹¶åŒæ­¥åˆ°ä¸»é¡µ
        run: |
          set -euo pipefail
          FORCE_UPDATE=${{ github.event.inputs.force_update || 'false' }}
          LOCAL_VERSION=$(cat version.txt 2>/dev/null || echo "")
          # å°è¯•æå–ç‰ˆæœ¬å·ï¼ˆå¯æ ¹æ®å®é™…è°ƒæ•´æ­£åˆ™ï¼‰
          TARGET_TAG=$(grep -oP '(?<=ç‰ˆæœ¬ )\d+\.\d+\.\d+' temp_readme.md)
          if [ -z "$TARGET_TAG" ]; then
            TARGET_TAG=$(curl -s https://api.github.com/repos/harry0703/MoneyPrinterTurbo/releases/latest | jq -r '.tag_name')
          fi

          # æå–èµ„äº§æ—¥å¿—ï¼ˆå‡è®¾æ ‡é¢˜ä¸ºâ€œæœ€æ–°èµ„äº§æ›´æ–°æ—¥å¿—â€ï¼Œæ ¹æ®å®é™…è°ƒæ•´ï¼‰
          ASSET_LOG=$(awk '/æœ€æ–°èµ„äº§æ›´æ–°æ—¥å¿—/,/^## /{if (/æœ€æ–°èµ„äº§æ›´æ–°æ—¥å¿—/) {p=1; next} if (/^## / && NR>1) {p=0} p}' temp_readme.md)
          if [ -n "$ASSET_LOG" ]; then
            # ä»…åœ¨ç‰ˆæœ¬å˜æ›´æˆ–å¼ºåˆ¶æ›´æ–°æ—¶å†™å…¥
            if [ "$LOCAL_VERSION" != "$TARGET_TAG" ] || [ "$FORCE_UPDATE" = "true" ]; then
              echo "$TARGET_TAG" > version.txt
              # æ¸…ç©ºæœ¬åœ°READMEåŸæœ‰èµ„äº§æ—¥å¿—éƒ¨åˆ†ï¼ˆä»¥â€œæœ€æ–°èµ„äº§æ›´æ–°æ—¥å¿—â€ä¸ºæ ‡è®°ï¼‰
              sed -i '/æœ€æ–°èµ„äº§æ›´æ–°æ—¥å¿—/,+1d' README.md
              echo -e "## æœ€æ–°èµ„äº§æ›´æ–°æ—¥å¿—\n$ASSET_LOG" >> README.md
            else
              echo "âœ… æ—¥å¿—å·²åŒæ­¥è‡³æœ€æ–°ç‰ˆæœ¬ï¼ˆ$TARGET_TAGï¼‰"
            fi
          else
            echo "æœªæå–åˆ°èµ„äº§æ—¥å¿—å†…å®¹"
          fi

      - name: æäº¤å˜æ›´
        if: always()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: ğŸ”„ åŒæ­¥èµ„äº§æ—¥å¿—åˆ°ä¸»é¡µå¹¶ä¿å­˜READMEå‰¯æœ¬
          files: |
            README.md
            version.txt
            temp_readme.md
