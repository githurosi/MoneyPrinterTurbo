name: 同步资产日志到主页并保存README副本
on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 1 * * *" # UTC+8凌晨1点
  workflow_dispatch:
    inputs:
      force_update:
        description: '是否强制更新'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  sync-readme:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: 检出当前仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # 浅克隆加速

      - name: 获取目标仓库README内容
        id: fetch-readme
        run: |
          set -euo pipefail
          TARGET_REPO="harry0703/MoneyPrinterTurbo"
          README_URL="https://raw.githubusercontent.com/${TARGET_REPO}/main/README.md"
          curl -s "$README_URL" > temp_readme.md
          echo "已将目标仓库README保存为temp_readme.md到仓库根目录"

      - name: 提取资产日志并同步到主页
        run: |
          set -euo pipefail
          FORCE_UPDATE=${{ github.event.inputs.force_update || 'false' }}
          LOCAL_VERSION=$(cat version.txt 2>/dev/null || echo "")
          # 尝试提取版本号（可根据实际调整正则）
          TARGET_TAG=$(grep -oP '(?<=版本 )\d+\.\d+\.\d+' temp_readme.md)
          if [ -z "$TARGET_TAG" ]; then
            TARGET_TAG=$(curl -s https://api.github.com/repos/harry0703/MoneyPrinterTurbo/releases/latest | jq -r '.tag_name')
          fi

          # 提取资产日志（假设标题为“最新资产更新日志”，根据实际调整）
          ASSET_LOG=$(awk '/最新资产更新日志/,/^## /{if (/最新资产更新日志/) {p=1; next} if (/^## / && NR>1) {p=0} p}' temp_readme.md)
          if [ -n "$ASSET_LOG" ]; then
            # 仅在版本变更或强制更新时写入
            if [ "$LOCAL_VERSION" != "$TARGET_TAG" ] || [ "$FORCE_UPDATE" = "true" ]; then
              echo "$TARGET_TAG" > version.txt
              # 清空本地README原有资产日志部分（以“最新资产更新日志”为标记）
              sed -i '/最新资产更新日志/,+1d' README.md
              echo -e "## 最新资产更新日志\n$ASSET_LOG" >> README.md
            else
              echo "✅ 日志已同步至最新版本（$TARGET_TAG）"
            fi
          else
            echo "未提取到资产日志内容"
          fi

      - name: 提交变更
        if: always()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 🔄 同步资产日志到主页并保存README副本
          files: |
            README.md
            version.txt
            temp_readme.md
