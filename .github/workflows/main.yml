name: åŒæ­¥READMEæ—¥å¿—ï¼ˆå¸¦é¡ºåºè°ƒæ•´ï¼‰
on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 1 * * *" # UTC+8å‡Œæ™¨1ç‚¹
  workflow_dispatch:
    inputs:
      force_update:
        description: 'æ˜¯å¦å¼ºåˆ¶æ›´æ–°'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  sync-readme:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # æµ…å…‹éš†åŠ é€Ÿ

      - name: è·å–ç›®æ ‡ä»“åº“READMEå†…å®¹
        id: fetch-readme
        run: |
          set -euo pipefail
          TARGET_REPO="harry0703/MoneyPrinterTurbo"
          README_URL="https://raw.githubusercontent.com/${TARGET_REPO}/main/README.md"
          curl -s "$README_URL" > temp_readme.md
          echo "æˆåŠŸè·å–ç›®æ ‡ä»“åº“READMEå†…å®¹ï¼Œä¿å­˜ä¸ºtemp_readme.md"
          # è¾“å‡ºtemp_readme.mdå‰å‡ è¡Œå†…å®¹ç”¨äºåˆæ­¥æŸ¥çœ‹
          head -n 5 temp_readme.md 

      - name: æå–å¹¶é‡ç»„æ—¥å¿—å†…å®¹
        run: |
          set -euo pipefail
          FORCE_UPDATE=${{ github.event.inputs.force_update || 'false' }}
          LOCAL_VERSION=$(cat version.txt 2>/dev/null || echo "")
          # å°è¯•ä»temp_readme.mdæå–ç‰ˆæœ¬å·ï¼Œè‹¥æœªæ‰¾åˆ°åˆ™ä»GitHub APIè·å–ï¼ˆå‡è®¾ä»“åº“æœ‰Releaseç‰ˆæœ¬ï¼‰
          TARGET_TAG=$(grep -oP '(?<=ç‰ˆæœ¬ )\d+\.\d+\.\d+' temp_readme.md)
          if [ -z "$TARGET_TAG" ]; then
            TARGET_TAG=$(curl -s https://api.github.com/repos/harry0703/MoneyPrinterTurbo/releases/latest | jq -r '.tag_name')
          fi
          echo "æå–åˆ°çš„ç‰ˆæœ¬å·ï¼š$TARGET_TAG"

          # æå–æœ€æ–°èµ„äº§æ›´æ–°æ—¥å¿—ï¼ˆæ ¹æ®ä½ æˆªå›¾æ ‡é¢˜è°ƒæ•´ï¼‰
          echo "å¼€å§‹æå–èµ„äº§æ—¥å¿—..."
          ASSET_LOG=$(awk '
            BEGIN {
              found = 0
            }
            /æœ€æ–°èµ„äº§æ›´æ–°æ—¥å¿—/{
              found = 1
              print "è¿›å…¥èµ„äº§æ—¥å¿—åŒ¹é…"
              next
            }
            found && /^## /{
              found = 0
            }
            found {
              print
            }
          ' temp_readme.md)
          echo "æå–åˆ°çš„èµ„äº§æ—¥å¿—å†…å®¹ï¼š$ASSET_LOG"

          # æå–é¡¹ç›®ä¸»é¡µæ—¥å¿—ï¼ˆæ’é™¤é‡å¤æ ‡é¢˜å¹²æ‰°ï¼Œåªå–ä¸€ä¸ªå®Œæ•´æ®µè½ï¼Œè¿™é‡Œå‡è®¾åç»­è¿˜æœ‰å…¶ä»–æ ‡é¢˜å¹²æ‰°ï¼‰
          echo "å¼€å§‹æå–é¡¹ç›®ä¸»é¡µæ—¥å¿—..."
          HOME_LOG=$(awk '
            BEGIN {
              flag = 0
              start = 0
            }
            /é¡¹ç›®ä¸»é¡µæ—¥å¿—/{
              flag = 1
              start = NR
              print "è¿›å…¥é¡¹ç›®ä¸»é¡µæ—¥å¿—åŒ¹é…"
              next
            }
            flag && /^## / && NR > start {
              flag = 0
            }
            flag {
              print
            }
          ' temp_readme.md)
          echo "æå–åˆ°çš„é¡¹ç›®ä¸»é¡µæ—¥å¿—å†…å®¹ï¼š$HOME_LOG"

          # ç»„åˆæ—¥å¿—é¡ºåºï¼šèµ„äº§æ—¥å¿— -> ä¸»é¡µæ—¥å¿—
          COMBINED_LOG=$(echo -e "$ASSET_LOG\n$HOME_LOG")

          # ä»…åœ¨ç‰ˆæœ¬å˜æ›´æˆ–å¼ºåˆ¶æ›´æ–°æ—¶å†™å…¥
          if [ "$LOCAL_VERSION" != "$TARGET_TAG" ] || [ "$FORCE_UPDATE" = "true" ]; then
            echo "$TARGET_TAG" > version.txt
            # å…ˆä¸ç›´æ¥ä¿®æ”¹æ–‡ä»¶ï¼Œè¾“å‡ºæŸ¥çœ‹sedæ“ä½œç»“æœ
            sed '/æœ€æ–°èµ„äº§æ›´æ–°æ—¥å¿—/,+1d' README.md > temp_sed.md
            echo "sedæ“ä½œåæ¨¡æ‹Ÿç»“æœï¼ˆæœªå®é™…å†™å…¥ï¼‰ï¼š"
            cat temp_sed.md
            # åœ¨READMEé¡¶éƒ¨æ’å…¥æ–°æ—¥å¿—ï¼ˆä¿ç•™åŸæœ‰éæ—¥å¿—å†…å®¹ï¼‰
            if [ -f "README.md" ]; then
              mv README.md old_README.md
              echo -e "## æœ€æ–°èµ„äº§æ›´æ–°æ—¥å¿—\n$ASSET_LOG\n## é¡¹ç›®ä¸»é¡µæ—¥å¿—\n$HOME_LOG\n\n" | cat - old_README.md > README.md
              rm old_README.md
            else
              echo -e "## æœ€æ–°èµ„äº§æ›´æ–°æ—¥å¿—\n$ASSET_LOG\n## é¡¹ç›®ä¸»é¡µæ—¥å¿—\n$HOME_LOG" > README.md
            fi
          else
            echo "âœ… æ—¥å¿—å·²åŒæ­¥è‡³æœ€æ–°ç‰ˆæœ¬ï¼ˆ$TARGET_TAGï¼‰"
          fi

      - name: æäº¤å˜æ›´
        if: always()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: ğŸ”„ åŒæ­¥READMEæ—¥å¿—ï¼ˆèµ„äº§ä¼˜å…ˆæ˜¾ç¤ºï¼‰
          files: |
            README.md
            version.txt
